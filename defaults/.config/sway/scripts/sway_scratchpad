#!/bin/bash

APP="$1"
MARK="scratchpad_${APP}" # Unique mark for each scratchpad

case "$APP" in
"journal")
  TITLE="journal"
  APP_ID="kitty"
  CMD="$TERMINAL --title journal $HOME/.config/i3/scripts/journal.sh"
  RESIZE="resize set 60ppt 60ppt"
  POSITION="move position center"
  ;;
"ranger")
  TITLE="ranger-scratchpad"
  APP_ID="kitty"
  CMD="$TERMINAL --title ranger-scratchpad ranger --cmd=\"set viewmode multipane\" --cmd=\"set column_ratios 1,1\" --cmd=\"tab_new\""
  RESIZE="resize set 80ppt 60ppt"
  POSITION="move position center"
  ;;
"terminal")
  TITLE="terminal-scratchpad" # Changed to avoid conflicts
  APP_ID="kitty"
  CMD="$TERMINAL -T terminal-scratchpad -o background_opacity=0.75"
  RESIZE="resize set 100ppt 40ppt"
  POSITION="move position 0px 2ppt"
  ;;
"ncpamixer")
  TITLE="ncpamixer-scratchpad" # Changed to avoid conflicts
  APP_ID="kitty"
  CMD="$TERMINAL -T ncpamixer-scratchpad -e ncpamixer -t o"
  RESIZE="resize set 80ppt 60ppt"
  POSITION="move position center"
  ;;
"qalculate")
  TITLE=""
  CLASS="qalculate-qt"
  CMD="qalculate-qt"
  RESIZE="resize set 50ppt 60ppt"
  POSITION="move position center"
  ;;
"tickrs")
  TITLE="tickrs-scratchpad" # Changed to avoid conflicts
  APP_ID="kitty"
  CMD="$TERMINAL -T tickrs-scratchpad -e tickrs"
  RESIZE="resize set 80ppt 80ppt"
  POSITION="move position center"
  ;;
"supersonic")
  TITLE=""           # Don't rely on title for XWayland
  CLASS="Supersonic" # Use class for XWayland app
  CMD="supersonic"
  RESIZE="resize set 80ppt 60ppt"
  POSITION="move position center"
  ;;
"feishin")
  TITLE=""
  APP_ID="feishin"
  CMD="feishin"
  RESIZE="resize set 80ppt 60ppt"
  POSITION="move position center"
  ;;
"htop")
  TITLE="htop-scratchpad" # Changed to avoid conflicts
  APP_ID="kitty"
  CMD="$TERMINAL -T htop-scratchpad -e htop"
  RESIZE="resize set 80ppt 60ppt"
  POSITION="move position center"
  ;;
"glances")
  TITLE="glances-scratchpad" # Changed to avoid conflicts
  APP_ID="kitty"
  CMD="$TERMINAL -T glances-scratchpad -e glances"
  RESIZE="resize set 80ppt 60ppt"
  POSITION="move position center"
  ;;
*)
  echo "Unknown app: $APP"
  exit 1
  ;;
esac

# Check if marked window exists
window_exists() {
  swaymsg -t get_tree | jq -e ".. | select(.marks? // [] | index(\"$MARK\"))" >/dev/null 2>&1
}

if window_exists; then
  # Window exists, toggle scratchpad using mark
  swaymsg "[con_mark=\"$MARK\"] scratchpad show, $RESIZE, $POSITION"
else
  # Launch the application
  eval "$CMD" &

  # Wait for window to appear and mark it
  for i in {1..30}; do
    sleep 0.1

    # Try to find and mark the window
    if [ -n "$CLASS" ]; then
      # XWayland app - match by class
      if swaymsg -t get_tree | jq -e ".. | select(.window_properties?.class? == \"$CLASS\")" >/dev/null 2>&1; then
        sleep 0.2
        swaymsg "[class=\"$CLASS\"] mark --add \"$MARK\", move scratchpad"
        sleep 0.1
        swaymsg "[con_mark=\"$MARK\"] scratchpad show, $RESIZE, $POSITION"
        break
      fi
    elif [ -n "$APP_ID" ]; then
      # Wayland app - match by app_id and title if specified
      if [ -n "$TITLE" ]; then
        if swaymsg -t get_tree | jq -e ".. | select(.app_id? == \"$APP_ID\" and .name? == \"$TITLE\")" >/dev/null 2>&1; then
          sleep 0.2
          swaymsg "[app_id=\"$APP_ID\" title=\"$TITLE\"] mark --add \"$MARK\", move scratchpad"
          sleep 0.1
          swaymsg "[con_mark=\"$MARK\"] scratchpad show, $RESIZE, $POSITION"
          break
        fi
      else
        if swaymsg -t get_tree | jq -e ".. | select(.app_id? == \"$APP_ID\")" >/dev/null 2>&1; then
          sleep 0.2
          swaymsg "[app_id=\"$APP_ID\"] mark --add \"$MARK\", move scratchpad"
          sleep 0.1
          swaymsg "[con_mark=\"$MARK\"] scratchpad show, $RESIZE, $POSITION"
          break
        fi
      fi
    fi
  done
fi
